C51 COMPILER V9.00   TIME                                                                  01/16/2019 10:26:32 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE TIME
OBJECT MODULE PLACED IN Time.OBJ
COMPILER INVOKED BY: D:\MCU\KEILMDK\C51\BIN\C51.EXE Time.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "DS1302.h"
   2          
   3          sbit CE         =       P3^5;    //RST
   4          sbit SCLK       =       P3^6;   
   5          sbit SDA        =       P3^4;    //DSIO
   6          
   7          unsigned char clockdata[8];
   8          unsigned char clockdataBCD[8];
   9          unsigned char BRAMdata[31];
  10          
  11          /*********************************************************************************************************
             -*****/
  12          //---DS1302Ð´ÈëºÍ¶ÁÈ¡Ê±·ÖÃëµÄµØÖ·ÃüÁî---//
  13          //---Ãë·ÖÊ±ÈÕÔÂÖÜÄê ×îµÍÎ»¶ÁÐ´Î»;-------//
  14          unsigned char code READ_RTC_ADDR[7] = {0x81, 0x83, 0x85, 0x87, 0x89, 0x8b, 0x8d}; 
  15          unsigned char code WRITE_RTC_ADDR[7] = {0x80, 0x82, 0x84, 0x86, 0x88, 0x8a, 0x8c};
  16          
  17          //---DS1302Ê±ÖÓ³õÊ¼»¯2013Äê1ÔÂ1ÈÕÐÇÆÚ¶þ10µã00·Ö00Ãë¡£---//
  18          //---´æ´¢Ë³ÐòÊÇÃë·ÖÊ±ÈÕÔÂÖÜÄê,´æ´¢¸ñÊ½ÊÇÓÃBCDÂë---//
  19          //unsigned char TIME[7] = {0, 0x42, 0x10, 0x10, 0x01, 0x03, 0x19};
  20          
  21          /*******************************************************************************
  22          * º¯ Êý Ãû         : Ds1302Write
  23          * º¯Êý¹¦ÄÜ                 : ÏòDS1302ÃüÁî£¨µØÖ·+Êý¾Ý£©
  24          * Êä    Èë         : addr,dat
  25          * Êä    ³ö         : ÎÞ
  26          *******************************************************************************/
  27          
  28          /*void Ds1302Write(unsigned char addr, unsigned char dat)
  29          {
  30                  unsigned char n;
  31                  CE = 0;
  32                  _nop_();
  33          
  34                  SCLK = 0;//ÏÈ½«SCLKÖÃµÍµçÆ½¡£
  35                  _nop_();
  36                  CE = 1; //È»ºó½«RST(CE)ÖÃ¸ßµçÆ½¡£
  37                  _nop_();
  38          
  39                  for (n=0; n<8; n++)//¿ªÊ¼´«ËÍ°ËÎ»µØÖ·ÃüÁî
  40                  {
  41                          SDA = addr & 0x01;//Êý¾Ý´ÓµÍÎ»¿ªÊ¼´«ËÍ
  42                          addr >>= 1;
  43                          SCLK = 1;//Êý¾ÝÔÚÉÏÉýÑØÊ±£¬DS1302¶ÁÈ¡Êý¾Ý
  44                          _nop_();
  45                          SCLK = 0;
  46                          _nop_();
  47                  }
  48                  for (n=0; n<8; n++)//Ð´Èë8Î»Êý¾Ý
  49                  {
  50                          SDA = dat & 0x01;
  51                          dat >>= 1;
  52                          SCLK = 1;//Êý¾ÝÔÚÉÏÉýÑØÊ±£¬DS1302¶ÁÈ¡Êý¾Ý
  53                          _nop_();
  54                          SCLK = 0;
C51 COMPILER V9.00   TIME                                                                  01/16/2019 10:26:32 PAGE 2   

  55                          _nop_();        
  56                  }       
  57                           
  58                  CE = 0;//´«ËÍÊý¾Ý½áÊø
  59                  _nop_();
  60          }*/
  61          
  62          /*******************************************************************************
  63          * º¯ Êý Ãû         : Ds1302Read
  64          * º¯Êý¹¦ÄÜ                 : ¶ÁÈ¡Ò»¸öµØÖ·µÄÊý¾Ý
  65          * Êä    Èë         : addr
  66          * Êä    ³ö         : dat
  67          *******************************************************************************/
  68           /*
  69          unsigned char Ds1302Read(unsigned char addr)
  70          {
  71                  unsigned char n,dat,dat1;
  72                  CE = 0;
  73                  _nop_();
  74          
  75                  SCLK = 0;//ÏÈ½«SCLKÖÃµÍµçÆ½¡£
  76                  _nop_();
  77                  CE = 1;//È»ºó½«RST(CE)ÖÃ¸ßµçÆ½¡£
  78                  _nop_();
  79          
  80                  for(n=0; n<8; n++)//¿ªÊ¼´«ËÍ°ËÎ»µØÖ·ÃüÁî
  81                  {
  82                          SDA = addr & 0x01;//Êý¾Ý´ÓµÍÎ»¿ªÊ¼´«ËÍ
  83                          addr >>= 1;
  84                          SCLK = 1;//Êý¾ÝÔÚÉÏÉýÑØÊ±£¬DS1302¶ÁÈ¡Êý¾Ý
  85                          _nop_();
  86                          SCLK = 0;//DS1302ÏÂ½µÑØÊ±£¬·ÅÖÃÊý¾Ý
  87                          _nop_();
  88                  }
  89                  _nop_();
  90                  for(n=0; n<8; n++)//¶ÁÈ¡8Î»Êý¾Ý
  91                  {
  92                          dat1 = SDA;//´Ó×îµÍÎ»¿ªÊ¼½ÓÊÕ
  93                          dat = (dat>>1) | (dat1<<7);
  94                          SCLK = 1;
  95                          _nop_();
  96                          SCLK = 0;//DS1302ÏÂ½µÑØÊ±£¬·ÅÖÃÊý¾Ý
  97                          _nop_();
  98                  }
  99          
 100                  CE = 0;
 101                  _nop_();        //ÒÔÏÂÎªDS1302¸´Î»µÄÎÈ¶¨Ê±¼ä,±ØÐëµÄ¡£
 102                  SCLK = 1;
 103                  _nop_();
 104                  SDA = 0;
 105                  _nop_();
 106                  SDA = 1;
 107                  _nop_();
 108                  return dat;     
 109          }  */
 110             
 111          /*******************************************************************************
 112          * º¯ Êý Ãû         : Ds1302Init
 113          * º¯Êý¹¦ÄÜ                 : ³õÊ¼»¯DS1302.
 114          * Êä    Èë         : ÎÞ
 115          * Êä    ³ö         : ÎÞ
 116          *******************************************************************************/
C51 COMPILER V9.00   TIME                                                                  01/16/2019 10:26:32 PAGE 3   

 117          
 118          /*void Ds1302Init()
 119          {
 120                  unsigned char n;
 121                  Ds1302Write(0x8E,0X00);          //½ûÖ¹Ð´±£»¤£¬¾ÍÊÇ¹Ø±ÕÐ´±£»¤¹¦ÄÜ
 122                  for (n=0; n<7; n++)//Ð´Èë7¸ö×Ö½ÚµÄÊ±ÖÓÐÅºÅ£º·ÖÃëÊ±ÈÕÔÂÖÜÄê
 123                  {
 124                          Ds1302Write(WRITE_RTC_ADDR[n],TIME[n]); 
 125                  }
 126                  Ds1302Write(0x8E,0x80);          //´ò¿ªÐ´±£»¤¹¦ÄÜ
 127          }*/
 128          
 129          /*******************************************************************************
 130          * º¯ Êý Ãû         : Ds1302ReadTime
 131          * º¯Êý¹¦ÄÜ                 : ¶ÁÈ¡Ê±ÖÓÐÅÏ¢
 132          * Êä    Èë         : ÎÞ
 133          * Êä    ³ö         : ÎÞ
 134          *******************************************************************************/
 135          
 136          /*void Ds1302ReadTime()
 137          {
 138                  unsigned char n;
 139                  for (n=0; n<7; n++)//¶ÁÈ¡7¸ö×Ö½ÚµÄÊ±ÖÓÐÅºÅ£º·ÖÃëÊ±ÈÕÔÂÖÜÄê
 140                  {
 141                          TIME[n] = Ds1302Read(READ_RTC_ADDR[n]);
 142                  }
 143                          
 144          }       */
 145          
 146          
 147          /*********************************************************************************************************
             -********/
 148          
 149          
 150          
 151          //ÏòDS1302Ð´Ò»¸ö×Ö½ÚµÄÊý¾Ý
 152          void DS1302_SPIwritebyte( unsigned char dat )
 153          {
 154   1              unsigned char i;
 155   1      
 156   1              for ( i = 0; i < 8; i++ )
 157   1              {       
 158   2                      SCLK = 0;
 159   2                      SDA = ( dat >> i ) & 0x01;
 160   2                                      
 161   2                      _nop_();
 162   2                      SCLK = 1;
 163   2              }
 164   1      }
 165          
 166          //´ÓDS1302¶ÁÒ»¸ö×Ö½ÚµÄÊý¾Ý
 167          unsigned char DS1302_SPIreadbyte( )
 168          {
 169   1              unsigned char i, tmp;
 170   1              
 171   1              tmp  = 0;
 172   1              for ( i = 0; i < 8; i++ )
 173   1              {
 174   2                      if ( SDA )
 175   2                              tmp = tmp | 0x80;
 176   2                      tmp = tmp >> 1;
 177   2      
C51 COMPILER V9.00   TIME                                                                  01/16/2019 10:26:32 PAGE 4   

 178   2                      SCLK = 1;
 179   2                      _nop_();
 180   2                      _nop_();
 181   2                      SCLK = 0;
 182   2              }
 183   1      
 184   1              SDA = 0; _nop_(); _nop_();                       //²»¼Ó»áÉÁÆÁ»òÏÔÊ¾85´íÎó
 185   1      
 186   1              return tmp;
 187   1      }
 188          
 189          //ÏòDS1302Ð´Ò»¸ö×Ö½ÚµÄÊý¾Ýµ½µØÖ·ÎªaddressµÄµ¥Ôª£¨¼Ä´æÆ÷£©
 190          void DS1302_writeybyte( unsigned char address, unsigned char dat )
 191          {
 192   1              CE = 0; _nop_();; 
 193   1              SCLK = 0; _nop_();
 194   1              SDA = 0; _nop_();
 195   1              CE = 1; _nop_();
 196   1      
 197   1              DS1302_SPIwritebyte( address );
 198   1              DS1302_SPIwritebyte( dat );     
 199   1              
 200   1              CE = 0; _nop_();_nop_();
 201   1              SCLK = 1; _nop_();_nop_();
 202   1              SDA = 1; _nop_();_nop_();        
 203   1      
 204   1      }
 205          
 206          //´ÓDS1302µÄaddressµÄµ¥Ôª£¨¼Ä´æÆ÷£©¶ÁÒ»¸ö×Ö½ÚµÄÊý¾Ý
 207          unsigned char DS1302_readbyte( unsigned char address )
 208          {
 209   1              unsigned char tmp;
 210   1      
 211   1              tmp = 0;
 212   1      
 213   1              CE = 0; _nop_(); 
 214   1              SCLK = 0; _nop_();
 215   1              SDA = 0; _nop_();
 216   1              CE = 1; _nop_();
 217   1      
 218   1              DS1302_SPIwritebyte( address );
 219   1              tmp =  DS1302_SPIreadbyte( );
 220   1      
 221   1              CE = 0; _nop_();_nop_();
 222   1              SCLK = 1; _nop_();_nop_();
 223   1              SDA = 1; _nop_();_nop_();
 224   1      
 225   1              return tmp;
 226   1      }
 227          
 228          
 229          //Í»·¢Ä£Ê½Ð´Ê±ÖÓÊý¾Ý£¬Êý¾Ý´æ·ÅÔÚclockdataBCD[8]ÖÐ
 230          void DS1302_writeclockburst( )
 231          {        
 232   1               unsigned char i;
 233   1               
 234   1               //È¡ÏûÐ´±£»¤
 235   1               DS1302_unlock();
 236   1      
 237   1               CE = 0; _nop_();; 
 238   1              SCLK = 0; _nop_();
 239   1              SDA = 0; _nop_();
C51 COMPILER V9.00   TIME                                                                  01/16/2019 10:26:32 PAGE 5   

 240   1              CE = 1; _nop_();
 241   1      
 242   1              //Ð´ÈëÍ»·¢Ä£Ê½Ð´¼Ä´æÆ÷µØÖ·
 243   1              DS1302_SPIwritebyte( DS1302_CLOCKBURST + DS1302_WRITE );
 244   1      
 245   1              for ( i = 0; i < 8; i++ )        //Á¬ÐøÐ´Èë8¸ö×Ö½ÚÊý¾Ý
 246   1                      DS1302_SPIwritebyte( clockdataBCD[i] ); 
 247   1              
 248   1              CE = 0; _nop_();_nop_();
 249   1              SCLK = 1; _nop_();_nop_();
 250   1              SDA = 1; _nop_();_nop_();
 251   1               
 252   1                              
 253   1               //¿ªÆôÐ´±£»¤
 254   1               DS1302_lock();
 255   1      }
 256          
 257          
 258          //Í»·¢Ä£Ê½¶ÁÊ±ÖÓÊý¾Ý£¬Êý¾Ý´æ·ÅÔÚclockdataBCD[8]ÖÐ
 259          void DS1302_readclockburst( )
 260          {
 261   1              unsigned char i;
 262   1               
 263   1               //È¡ÏûÐ´±£»¤
 264   1              DS1302_unlock();
 265   1      
 266   1              CE = 0; _nop_();; 
 267   1              SCLK = 0; _nop_();
 268   1              SDA = 0; _nop_();
 269   1              CE = 1; _nop_();
 270   1      
 271   1              //Ð´ÈëÍ»·¢Ä£Ê½Ð´¼Ä´æÆ÷µØÖ·
 272   1              DS1302_SPIwritebyte( DS1302_CLOCKBURST + DS1302_READ );
 273   1      
 274   1              for ( i = 0; i < 8; i++ )         //Á¬Ðø¶ÁÈ¡8¸ö×Ö½ÚÊý¾Ý
 275   1                      clockdataBCD[i] = DS1302_SPIreadbyte( );        
 276   1              
 277   1              CE = 0; _nop_();_nop_();
 278   1              SCLK = 1; _nop_();_nop_();
 279   1              SDA = 1; _nop_();_nop_(); 
 280   1                              
 281   1               //¿ªÆôÐ´±£»¤
 282   1               DS1302_lock();
 283   1      }
 284          
 285          
 286          //Í»·¢Ä£Ê½Ð´ramÊý¾Ý£¬Êý¾Ý´æ·ÅÔÚBRAMdata[31]ÖÐ
 287          void DS1302_writeramburst( )
 288          {
 289   1               unsigned char i;
 290   1               
 291   1               //È¡ÏûÐ´±£»¤
 292   1               DS1302_unlock();
 293   1      
 294   1               CE = 0; _nop_();; 
 295   1              SCLK = 0; _nop_();
 296   1              SDA = 0; _nop_();
 297   1              CE = 1; _nop_();
 298   1      
 299   1              //Ð´ÈëÍ»·¢Ä£Ê½Ð´¼Ä´æÆ÷µØÖ·
 300   1              DS1302_SPIwritebyte( DS1302_BRAMBURST + DS1302_WRITE );
 301   1      
C51 COMPILER V9.00   TIME                                                                  01/16/2019 10:26:32 PAGE 6   

 302   1              for ( i = 0; i < 31; i++ )       //Á¬ÐøÐ´Èë31¸ö×Ö½ÚÊý¾Ý
 303   1                      DS1302_SPIwritebyte( BRAMdata[i] );     
 304   1              
 305   1              CE = 0; _nop_();_nop_();
 306   1              SCLK = 1; _nop_();_nop_();
 307   1              SDA = 1; _nop_();_nop_();        
 308   1                              
 309   1              //¿ªÆôÐ´±£»¤
 310   1              DS1302_lock();  
 311   1      }
 312          
 313          //Í»·¢Ä£Ê½¶ÁramÊý¾Ý£¬Êý¾Ý´æ·ÅÔÚBRAMdata[31]ÖÐ
 314          void DS1302_readramburst( )
 315          {
 316   1              unsigned char i;
 317   1               
 318   1               //È¡ÏûÐ´±£»¤
 319   1              DS1302_unlock();
 320   1      
 321   1              CE = 0; _nop_();; 
 322   1              SCLK = 0; _nop_();
 323   1              SDA = 0; _nop_();
 324   1              CE = 1; _nop_();
 325   1      
 326   1              //Ð´ÈëÍ»·¢Ä£Ê½Ð´¼Ä´æÆ÷µØÖ·
 327   1              DS1302_SPIwritebyte( DS1302_BRAMBURST + DS1302_READ );
 328   1      
 329   1              for ( i = 0; i < 31; i++ )       //Á¬Ðø¶ÁÈ¡31¸ö×Ö½ÚÊý¾Ý
 330   1                      BRAMdata[i] = DS1302_SPIreadbyte( );    
 331   1              
 332   1              CE = 0; _nop_();_nop_();
 333   1              SCLK = 1; _nop_();_nop_();
 334   1              SDA = 1; _nop_();_nop_();
 335   1               
 336   1                              
 337   1              //¿ªÆôÐ´±£»¤
 338   1              DS1302_lock();
 339   1      }
 340          
 341          
 342          //ÉÏËø£¨¿ªÆôÐ´±£»¤£©
 343          void DS1302_lock()
 344          {
 345   1              DS1302_writeybyte( DS1302_CONTROL +  DS1302_WRITE, 0x80 );
 346   1      }
 347          
 348          //½âËø£¨È¡ÏûÐ´±£»¤£©
 349          void DS1302_unlock()
 350          {
 351   1              DS1302_writeybyte( DS1302_CONTROL +  DS1302_WRITE, 0x00 );
 352   1      }
 353          
 354          
 355          //»ñµÃÃëÖÓÊý¾Ý£¬Êä³öÎª¶þ½øÂë
 356          unsigned char DS1302_getsecond()                                  //Ãë
 357          {
 358   1              unsigned char tmp;
 359   1      
 360   1              //¶ÁÈ¡ÃëÊý¾Ý£¬tmpÎªBCDÂë
 361   1              tmp = DS1302_readbyte ( DS1302_SECOND + DS1302_READ );
 362   1              
 363   1              //(tmp & 0x70) >> 4µÃµ½ÃëµÄÊ®Î»²¿·Ö£¬(tmp & 0x0F)µÃµ½ÃëµÄ¸öÎ»²¿·Ö
C51 COMPILER V9.00   TIME                                                                  01/16/2019 10:26:32 PAGE 7   

 364   1              return ( ((tmp & 0x70) >> 4) * 10 + (tmp & 0x0F) );
 365   1      }
 366          
 367          //»ñµÃ·ÖÖÓÊý¾Ý£¬Êä³öÎª¶þ½øÂë
 368          unsigned char DS1302_getminute()                                  //·Ö
 369          {
 370   1              unsigned char tmp;
 371   1      
 372   1              //¶ÁÈ¡·ÖÊý¾Ý£¬tmpÎªBCDÂë
 373   1              tmp = DS1302_readbyte ( DS1302_MINUTE + DS1302_READ );
 374   1              
 375   1              //(tmp & 0x70) >> 4µÃµ½·ÖµÄÊ®Î»²¿·Ö£¬(tmp & 0x0F)µÃµ½·ÖµÄ¸öÎ»²¿·Ö
 376   1              return ( ((tmp & 0x70) >> 4) * 10 + (tmp & 0x0F) );
 377   1      }
 378          
 379          //»ñµÃÐ¡Ê±Êý¾Ý£¬Êä³öÎª¶þ½øÂë£¬24½øÖÆ
 380          unsigned char DS1302_gethour()                                    //Ê±
 381          {
 382   1              unsigned char tmp;
 383   1      
 384   1              //¶ÁÈ¡Ð¡Ê±Êý¾Ý£¬tmpÎªBCDÂë
 385   1              tmp = DS1302_readbyte ( DS1302_HOUR + DS1302_READ );
 386   1      
 387   1              //×î¸ßÎ»¡¾7¡¿Çø·Ö12½øÖÆ¡¢24½øÖÆ
 388   1              if ( tmp & 0x80 ) //==========================12Ð¡Ê±ÖÆ
 389   1                      //(( tmp & 0x20 ) >> 5)Çø·ÖAM(0)¡¢PM(1),0x20¶ÔÓ¦µÚ5Î»,PMÐèÒª¼Ó12, AM²»ÐèÒª¼Ó12
 390   1                      //( tmp & 0x10 ) >> 4)µÃµ½Ê±µÄÊ®Î»²¿·Ö£¬0x10¶ÔÓ¦µÚ4Î»
 391   1                      //(tmp & 0x0F)µÃµ½Ê±µÄ¸öÎ»²¿·Ö  
 392   1                      return ( (( tmp & 0x20 ) >> 5) * 12 + (( tmp & 0x10 ) >> 4) * 10  + ( tmp & 0x0F ) ) ;  
 393   1              else                    //==========================24Ð¡Ê±ÖÆ
 394   1                      //( tmp & 0x20 ) >> 5)µÃµ½Ê±µÄµÚ¶þ¸öÊ®Î»²¿·Ö£¬(( tmp & 0x10 ) >> 4)µÃµ½Ê±µÄµÚÒ»¸öÊ®Î»²¿·Ö£¬(tmp & 0x0F)µ
             -Ãµ½Ê±µÄ¸öÎ»²¿·Ö
 395   1                  return ( (( tmp & 0x20 ) >> 5) * 20 + (( tmp & 0x10 ) >> 4) * 10  + ( tmp & 0x0F ) ) ;
 396   1      }
 397          
 398          //»ñµÃÈÕÆÚ
 399          unsigned char DS1302_getdate()                                    //ÈÕ
 400          {
 401   1              unsigned char tmp;
 402   1      
 403   1              //¶ÁÈ¡ÈÕÆÚÊý¾Ý£¬tmpÎªBCDÂë
 404   1              tmp = DS1302_readbyte ( DS1302_DATE + DS1302_READ );
 405   1              
 406   1              //(tmp & 0x30) >> 4µÃµ½ÈÕÆÚµÄÊ®Î»²¿·Ö£¬(tmp & 0x0F)µÃµ½ÈÕÆÚµÄ¸öÎ»²¿·Ö
 407   1              return ( ((tmp & 0x30) >> 4) * 10 + (tmp & 0x0F) );     
 408   1      }
 409          
 410          //»ñµÃÔÂ·Ý
 411          unsigned char DS1302_getmonth()                           //ÔÂ
 412          {
 413   1              unsigned char tmp;
 414   1      
 415   1              //¶ÁÈ¡ÔÂ·ÝÊý¾Ý£¬tmpÎªBCDÂë
 416   1              tmp = DS1302_readbyte ( DS1302_MONTH + DS1302_READ );
 417   1              
 418   1              //(tmp & 0x10) >> 4µÃµ½ÔÂµÄÊ®Î»²¿·Ö£¬(tmp & 0x0F)µÃµ½ÔÂµÄ¸öÎ»²¿·Ö
 419   1              return ( ((tmp & 0x10) >> 4) * 10 + (tmp & 0x0F) );     
 420   1      }
 421          
 422          //»ñµÃÐÇÆÚ
 423          unsigned char DS1302_getweekday()                                 //ÖÜ
 424          {
C51 COMPILER V9.00   TIME                                                                  01/16/2019 10:26:32 PAGE 8   

 425   1              unsigned char tmp;
 426   1      
 427   1              //¶ÁÈ¡ÐÇÆÚÊý¾Ý£¬tmpÎªBCDÂë
 428   1              tmp = DS1302_readbyte ( DS1302_WEEKDAY + DS1302_READ );
 429   1              
 430   1              //(tmp & 0x07)µÃµ½ÐÇÆÚ¼¸
 431   1              return ( tmp & 0x07 );  
 432   1      }
 433          
 434          //»ñµÃÄê·Ö
 435          unsigned char DS1302_getyear()                                    //Äê
 436          {
 437   1              unsigned char tmp;
 438   1      
 439   1              //¶ÁÈ¡ÐÇÆÚÊý¾Ý£¬tmpÎªBCDÂë
 440   1              tmp = DS1302_readbyte ( DS1302_YEAR + DS1302_READ );
 441   1              
 442   1              //¸ß4Î»ÎªÄêµÄÊ®Î»²¿·Ö£¬µÍ4Î»ÎªÄêµÄ¸öÎ»²¿·Ö
 443   1              return ( ((tmp & 0xF0) >> 4) * 10 + (tmp & 0x0F) );
 444   1      }
 445          
 446          
 447          
 448          //ÉèÖÃÊ±ÖÓ---ÃëÊý¾Ý£¬ÊäÈëÎª¶þ½øÂë
 449          void DS1302_setsecond( unsigned char second )     //Ãë
 450          {
 451   1              if ( second > 59 )
 452   1                      return;
 453   1              
 454   1              //ÏÈ½âËø
 455   1              DS1302_unlock();
 456   1      
 457   1              //Ð´ÈëÊý¾Ý£¬µØÖ·ÎªDS1302_SECOND + DS1302_WRITE£¬ÐèÒª×ª»»ÎªBCDÂë
 458   1              //(second/10)µÃµ½ÃëµÄÊ®Î»£¬( second %10 )µÃµ½ÃëµÄ¸öÎ»
 459   1              DS1302_writeybyte( DS1302_SECOND + DS1302_WRITE, (((second/10) & 0x07) << 4) | ( second %10 ) );
 460   1              
 461   1              //ÉÏËø
 462   1              DS1302_lock();
 463   1      }
 464          
 465          //ÉèÖÃÊ±ÖÓ---·ÖÊý¾Ý£¬ÊäÈëÎª¶þ½øÂë
 466          void DS1302_setminute( unsigned char minute )     //·Ö
 467          {
 468   1              if ( minute > 59 )
 469   1                      return;
 470   1              
 471   1              //ÏÈ½âËø
 472   1              DS1302_unlock();
 473   1      
 474   1              //Ð´ÈëÊý¾Ý£¬µØÖ·ÎªDS1302_MINUTE + DS1302_WRITE£¬ÐèÒª×ª»»ÎªBCDÂë
 475   1              //(second/10)µÃµ½·ÖµÄÊ®Î»£¬( second %10 )µÃµ½·ÖµÄ¸öÎ»
 476   1              DS1302_writeybyte( DS1302_MINUTE + DS1302_WRITE, (((minute/10) & 0x07) << 4) | ( minute %10 ) );
 477   1              
 478   1              //ÉÏËø
 479   1              DS1302_lock();
 480   1      }
 481          
 482          //ÉèÖÃÊ±ÖÓ---Ê±Êý¾Ý£¬ÊäÈëÎª24Ð¡Ê±½øÖÆ¶þ½øÂë 
 483          void DS1302_sethour( unsigned char hour )                 //Ê±
 484          {
 485   1              unsigned char tmp;      
 486   1      
C51 COMPILER V9.00   TIME                                                                  01/16/2019 10:26:32 PAGE 9   

 487   1              tmp = 0;
 488   1      
 489   1              //»ñµÃDS1302µ±Ç°µÄÐ¡Ê±½øÖÆ
 490   1              if ( DS1302_readbyte ( DS1302_HOUR + DS1302_READ ) & 0x80 )                                              //12Ð¡Ê±ÖÆ
 491   1              {
 492   2                      tmp = tmp | 0x80;                               //»¹ÊÇ12Ð¡Ê±ÖÆ
 493   2                      if ( hour > 12 )                                //PM
 494   2                      {
 495   3                              tmp = tmp | 0x20;                       //µÚ5Î»Îª1±íÊ¾PM,Îª0±íÊ¾AM£¨Ê¡ÂÔ£©
 496   3                              hour = hour - 12;
 497   3                      }                               
 498   2              }
 499   1              else                                                                     //24Ð¡Ê±ÖÆ
 500   1              {
 501   2                      if ( hour > 20 )
 502   2                      {
 503   3                              tmp = tmp | 0x20;                               //µÚ¶þ¸öÊ®
 504   3                              hour = hour - 20;
 505   3                      }
 506   2              }
 507   1              
 508   1              if ( hour > 9 )                         //ÉèÖÃ12Ð¡Ê±ÖÆµÄÊ®Î»»ò24Ð¡Ê±ÖÆµÄµÚÒ»¸öÊ®;
 509   1                              tmp = tmp | 0x10;               //µÚ4Î»
 510   1      
 511   1              tmp = tmp | (( hour % 10 ) & 0x0F);     //¸öÎ»ÎªµÍ4Î»   
 512   1      
 513   1              //ÏÈ½âËø
 514   1              DS1302_unlock();
 515   1      
 516   1              //Ð´ÈëÊý¾Ý£¬µØÖ·ÎªDS1302_HOUR + DS1302_WRITE£¬tmpÒÑ¾­×ª»»ÎªBCDÂë
 517   1              DS1302_writeybyte( DS1302_HOUR + DS1302_WRITE, tmp );
 518   1              
 519   1              //ÉÏËø
 520   1              DS1302_lock();  
 521   1      }
 522          
 523          //ÉèÖÃÊ±ÖÓ---ÈÕÆÚÊý¾Ý£¬ÊäÈëÎª¶þ½øÂë
 524          void DS1302_setdate( unsigned char date )                 //ÈÕ
 525          {
 526   1              if ( date > 31 )
 527   1                      return;
 528   1              
 529   1              //ÏÈ½âËø
 530   1              DS1302_unlock();
 531   1      
 532   1              //Ð´ÈëÊý¾Ý£¬µØÖ·ÎªDS1302_DATE + DS1302_WRITE£¬ÐèÒª×ª»»ÎªBCDÂë
 533   1              //(date/10)µÃµ½ÈÕÆÚµÄÊ®Î»£¬( date %10 )µÃµ½ÈÕÆÚµÄ¸öÎ»
 534   1              DS1302_writeybyte( DS1302_DATE + DS1302_WRITE, (((date/10) & 0x03) << 4) | ( date %10 ) );
 535   1              
 536   1              //ÉÏËø
 537   1              DS1302_lock();
 538   1      }
 539          
 540          //ÉèÖÃÊ±ÖÓ---ÔÂ·ÝÊý¾Ý£¬ÊäÈëÎª¶þ½øÂë
 541          void DS1302_setmonth( unsigned char month )             //ÔÂ
 542          {
 543   1              if ( month > 12 || month < 1 )
 544   1                      return;
 545   1              
 546   1              //ÏÈ½âËø
 547   1              DS1302_unlock();
 548   1      
C51 COMPILER V9.00   TIME                                                                  01/16/2019 10:26:32 PAGE 10  

 549   1              //Ð´ÈëÊý¾Ý£¬µØÖ·ÎªDS1302_MONTH + DS1302_WRITE£¬ÐèÒª×ª»»ÎªBCDÂë
 550   1              //(month/10)µÃµ½ÔÂµÄÊ®Î»£¬( month %10 )µÃµ½ÔÂµÄ¸öÎ»
 551   1              DS1302_writeybyte( DS1302_MONTH + DS1302_WRITE, (((month/10) & 0x01) << 4) | ( month % 10 ) );
 552   1              
 553   1              //ÉÏËø
 554   1              DS1302_lock();  
 555   1      }
 556          
 557          //ÉèÖÃÊ±ÖÓ---ÐÇÆÚÊý¾Ý£¬ÊäÈëÎª¶þ½øÂë
 558          void DS1302_setweekday( unsigned char weekday )  //ÖÜ
 559          {
 560   1              if ( weekday > 7 || weekday < 1 )                       //¼ì²éÊý¾ÝÓÐÐ§ÐÔ
 561   1                      return;
 562   1              
 563   1              //ÏÈ½âËø
 564   1              DS1302_unlock();
 565   1      
 566   1              //Ð´ÈëÊý¾Ý£¬µØÖ·ÎªDS1302_WEEKDAY + DS1302_WRITE£¬ÐèÒª×ª»»ÎªBCDÂë
 567   1              //(weekday & 0x07)µÃµ½ÐÇÆÚÖµ
 568   1              DS1302_writeybyte( DS1302_WEEKDAY + DS1302_WRITE, ( weekday & 0x07 ) );
 569   1              
 570   1              //ÉÏËø
 571   1              DS1302_lock();
 572   1      }
 573          
 574          //ÉèÖÃÊ±ÖÓ---ÄêÊý¾Ý£¬ÊäÈëÎª¶þ½øÂë
 575          void DS1302_setyear( unsigned char year )               //Äê
 576          {
 577   1              if ( year > 99 )                        //¼ì²éÊý¾ÝÓÐÐ§ÐÔ
 578   1                      return;
 579   1      
 580   1              //ÏÈ½âËø
 581   1              DS1302_unlock();
 582   1      
 583   1              //Ð´ÈëÊý¾Ý£¬µØÖ·ÎªDS1302_YEAR + DS1302_WRITE£¬ÐèÒª×ª»»ÎªBCDÂë
 584   1              //(weekday & 0x07)µÃµ½ÐÇÆÚÖµ
 585   1              DS1302_writeybyte( DS1302_YEAR + DS1302_WRITE, ( ((year/10) & 0x0F) << 4) | ((year % 10) & 0x0F) );
 586   1              
 587   1              //ÉÏËø
 588   1              DS1302_lock();
 589   1      }
 590          
 591          
 592          
 593          //ÉèÖÃDS1302µÄÊ±¼ä£¬ÊäÈëÊý¾Ý´æ·ÅÔÚclockdataÊý×éÖÐ
 594          void DS1302_settime( )
 595          {
 596   1               DS1302_setsecond( clockdata[0] );                      //Ãë
 597   1               DS1302_setminute( clockdata[1] );                      //·Ö
 598   1               DS1302_sethour( clockdata[2] );                  //Ê±
 599   1               DS1302_setdate( clockdata[3] );                  //ÈÕ
 600   1               DS1302_setmonth( clockdata[4] );                       //ÔÂ
 601   1               DS1302_setyear( clockdata[5] );                  //Äê
 602   1               DS1302_setweekday( clockdata[6] );             //ÖÜ
 603   1                              
 604   1      }
 605          
 606          //»ñÈ¡DS1302µÄÊ±¼ä£¬Êä³öÊý¾Ý´æ·ÅÔÚclockdataÊý×éÖÐ 
 607          void DS1302_gettime( )
 608          {
 609   1              clockdata[0]  = DS1302_getsecond();                               //Ãë
 610   1              clockdata[1]  = DS1302_getminute();                               //·Ö
C51 COMPILER V9.00   TIME                                                                  01/16/2019 10:26:32 PAGE 11  

 611   1              clockdata[2]  = DS1302_gethour();                                         //Ê±
 612   1              clockdata[3]  = DS1302_getdate();                                         //ÈÕ
 613   1              clockdata[4]  = DS1302_getmonth();                                //ÔÂ
 614   1              clockdata[5]  = DS1302_getyear();                                         //Äê
 615   1              clockdata[6]  = DS1302_getweekday();                              //ÖÜ  
 616   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    895    ----
   CONSTANT SIZE    =     14    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     47    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
